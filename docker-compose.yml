version: "3.9"

services:
  fr:
    build: .
    image: cv-fr-mvp
    command: ["fr", "-h"]
    volumes:
      - ./dataset:/app/dataset
      - ./models:/app/models
      - ./:/host
      - ./samples:/app/samples
    profiles: ["default"]
    # Optional GPU profile; requires NVIDIA drivers and runtime
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video

  ui:
    build: .
    image: cv-fr-mvp
    command: ["streamlit", "run", "ui/streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    ports:
      - "8501:8501"
    volumes:
      - ./models:/app/models
      - ./dataset:/app/dataset
    profiles: ["default"]

  web:
    build: .
    image: cv-fr-mvp
    command: ["python", "manage.py", "runserver", "0.0.0.0:8000"]
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
      - ./dataset:/app/dataset
    environment:
      - FR_KNN_PATH=/app/models/knn.joblib
