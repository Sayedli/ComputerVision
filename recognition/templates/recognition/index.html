<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Face Recognition – Django</title>
    <style>
      :root{
        /* ff9933 palette */
        --bg:#fff3e6; --panel:#ffe6cc; --accent:#ff9933; --accent2:#ff8c1a; --text:#2e1f14; --muted:#7a5a3a; --border:#ffd9b3;
      }
      body.dark{
        --bg:#1f130a; --panel:#2b1a0e; --accent:#ff9933; --accent2:#ff8c1a; --text:#fff0e0; --muted:#c9a789; --border:#4a2e1c;
      }
      html,body{ height:100%; }
      body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: radial-gradient(1200px 600px at 10% -10%, #ffe9d6 0%, var(--bg) 40%, var(--bg) 100%); color:var(--text); transition: background .3s ease, color .3s ease; }
      .container{ max-width:1100px; margin: 0 auto; padding: 2rem 1rem; }
      .header h1{ margin:0 0 .25rem; }
      .subtitle{ color:var(--muted); margin:.25rem 0 1.5rem; }
      .row{ display:flex; gap:1.5rem; align-items:flex-start; flex-wrap:wrap; }
      .panel{ flex:1 1 360px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:1rem 1.1rem; box-shadow:0 6px 20px rgba(245,158,11,.08); }
      .error{ color:#b00020; font-weight:600; }
      .btn{ background:linear-gradient(180deg, var(--accent), var(--accent2)); color:white; border:none; padding:.6rem 1rem; border-radius:10px; cursor:pointer; box-shadow:0 4px 12px rgba(255, 153, 51, .25); }
      .btn:hover{ filter:brightness(.98); }
      .link{ color:var(--accent2); text-decoration:none; margin-left:.5rem; }
      .link:hover{ text-decoration:underline; }
      table{ border-collapse:collapse; width:100%; background:white; border-radius:10px; overflow:hidden; }
      th,td{ padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
      th{ background:#fff; }
      .footer{ color:var(--muted); margin-top:1rem; font-size:.95rem; }
      /* Camera */
      .cam{ display:flex; flex-direction:column; gap:.6rem; align-items:center; }
      .cam video{ width:100%; max-width:520px; border-radius:12px; border:1px solid var(--border); background:#000; box-shadow:0 6px 20px rgba(0,0,0,.15); }
      .cam .row{ display:flex; gap:.75rem; align-items:center; }
      .toggle{ display:inline-flex; align-items:center; gap:.5rem; padding:.3rem .6rem; border:1px solid var(--border); border-radius:999px; background:var(--panel); }
      .toggle button{ background:var(--accent); color:white; border:none; padding:.25rem .6rem; border-radius:999px; cursor:pointer; }
      /* Spinner overlay */
      .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:9999; }
      .overlay.show{ display:flex; }
      .spinner{ width:56px; height:56px; border-radius:50%; border:6px solid rgba(255,153,51,.25); border-top-color: var(--accent); animation: spin 1s linear infinite; background:var(--panel); box-shadow:0 6px 18px rgba(0,0,0,.2); }
      @keyframes spin{ to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div id="overlay" class="overlay"><div class="spinner"></div></div>
    <div class="container">
      <div class="header">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
          <h1 style="margin:0">Face Recognition</h1>
          <div style="display:flex;align-items:center;gap:1rem;">
            <div class="toggle"><span id="theme-label">Light</span><button id="theme-btn" type="button">Toggle</button></div>
            <a href="/manage" class="link">Manage (encode/train)</a>
          </div>
        </div>
      </div>

      {% if error %}<p class="error">Error: {{ error }}</p>{% endif %}
      {% if message %}<p>{{ message }}</p>{% endif %}

      <div class="row">
        <div class="panel">
          <h3>Webcam</h3>
          <form id="recognize-form" method="post" enctype="multipart/form-data" class="cam">
            {% csrf_token %}
            <input id="file-input" type="file" name="image" accept="image/*" style="display:none" required />
            <video id="cam" autoplay playsinline muted></video>
            <div class="row">
              <button class="btn" id="capture" type="button">Capture & Recognize</button>
              <a class="link" href="/reload">Reload Model</a>
              <span id="file-name" class="subtitle"></span>
            </div>
          </form>
          <p class="subtitle" style="margin-top:.5rem">Tip: good lighting and centered faces help recognition.</p>
        </div>

        <div class="panel">
          <h3>Annotated Result</h3>
          {% if image_data_url %}
            <img src="{{ image_data_url }}" alt="Annotated" style="max-width: 640px; width:100%; height:auto; border-radius:10px; border:1px solid var(--border);" />
          {% else %}
            <p class="subtitle">No image yet — choose a photo to get started.</p>
          {% endif %}
        </div>
      </div>

      {% if message %}
        <p class="subtitle">{{ message }}</p>
      {% endif %}

      <script>
        (function(){
          const body = document.body;
          const overlay = document.getElementById('overlay');
          const form = document.getElementById('recognize-form');
          const fi = document.getElementById('file-input');
          const fn = document.getElementById('file-name');
          const cam = document.getElementById('cam');
          const captureBtn = document.getElementById('capture');
          const themeBtn = document.getElementById('theme-btn');
          const themeLabel = document.getElementById('theme-label');

          // Theme toggle with localStorage
          const saved = localStorage.getItem('theme') || 'light';
          if(saved === 'dark'){ body.classList.add('dark'); themeLabel.textContent='Dark'; }
          themeBtn.addEventListener('click', () => {
            body.classList.toggle('dark');
            const mode = body.classList.contains('dark') ? 'dark' : 'light';
            themeLabel.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
            localStorage.setItem('theme', mode);
          });

          // Start webcam
          async function startCam(){
            try{
              const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
              cam.srcObject = stream;
            }catch(err){
              cam.insertAdjacentHTML('afterend', `<div class="subtitle">Camera unavailable: ${err.message}</div>`);
            }
          }
          startCam();

          // Capture snapshot → file input → submit form
          captureBtn.addEventListener('click', async () => {
            if(!cam.srcObject){ return; }
            const v = cam;
            const canvas = document.createElement('canvas');
            canvas.width = v.videoWidth || 640; canvas.height = v.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
              if(!blob){ return; }
              const file = new File([blob], 'snapshot.jpg', { type: 'image/jpeg' });
              const dt = new DataTransfer(); dt.items.add(file); fi.files = dt.files; fn.textContent = file.name;
              overlay.classList.add('show');
              form.submit();
            }, 'image/jpeg', 0.9);
          });
        })();
      </script>
    </div>

  </body>
  </html>
